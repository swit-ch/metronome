<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width user-scalable=no">
    <title>Metronome swit-ch testing</title>
    <!-- <link rel="stylesheet" href="css/main.css"> -->
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <style type="text/css">
      body {
        font-family: sans-serif;
        line-height: 1.8;
      }
/* 
      body > * 
 */
      body *
      {
        /* border: 0.5px solid gray; */
        /* background-color: rgba(200, 200, 255, 0.1); */
      }
      
      div#controls > div {
        padding: 0.3em 0;
      }
      div.hasSlider {
        border-top: 0.5px solid gray;
      }
      div#lastSlider {
        border-bottom: 0.5px solid gray;
      }
      
      input {
        vertical-align: middle;
      }
        /* https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Forms/Styling_HTML_forms */
      button, input, select, textarea {
        font-family : inherit;
        font-size   : 100%;
        line-height: inherit; /* button iOS ? */
      }
      #showTempo, #showGain { 
        display: inline-block;
      }
      #showTempo, #showGain, select, button {
        width: 5em;
        text-align: center; /* not for select ? */
      }
      .activeCtl {
        /* background-color: rgba(200, 200, 255, 0.25); */ /* not visible in slider */
      }
      .ctlLabel {
        display: inline-block;
        width: 7em;
        text-align: right;
        padding-right: 1ex;
      }
      .info { display: none; }
      canvas {
        width: 100%;
        height: 30px;
      }
      #debugContainer button {
        display: none;
      }
      div#debugField {
          font-family: monospace;
      }
    </style>
    <script src="js/AudioContextMonkeyPatch.js"></script> 
    <script src="js/metronome.js"></script>
  </head>
  <body>
    <div id="controls">
      <!-- class 'play' rules in main.css, not used currently -->
      <div><button type="button" id="playCtl" autofocus="true" class="play activeCtl" tabindex="0"> HÃ¤? </button></div>
      
      <!-- is this a table ? A form? -->
      <div><span class="ctlLabel">Beats per bar: </span><select id="beatsPerBarCtl" class="activeCtl"></select></div>
      <div><span class="ctlLabel">Beat unit: </span><select id="beatUnitCtl" class="activeCtl"></select></div>
      <div class="hasSlider"><span class="ctlLabel">Tempo: </span><span id="showTempo"></span><span class="info">BPM</span><input id="tempoCtl" type="range" class="activeCtl"></div>      
      <div class="hasSlider" id="lastSlider"><span class="ctlLabel">Gain: </span><span id="showGain"></span><input type="range" id="gainCtl" class="activeCtl"></div>
    </div>
    <div><canvas id="beatCanvas"></canvas></div>
    <div id="debugContainer">
      <button type="button" id="trigCtl" class="activeCtl" tabindex="0">Trig 0</button>
      <button type="button" id="trigCtl1" class="activeCtl" tabindex="0">Trig 1</button>
      <div id="debugField"></div>
    </div>
    
    <script type="text/javascript"> 
      'use strict';
            
      // initial tempo, gain defined in metronome.js -- test override here
      // no localStorage in Opera mini (but audio a.o. doesn't work there anyway ...)
      // 
      var storage = window.localStorage; // possibly undefined (Opera mini)
            
      if (storage) { // oh, values always strings ?!
        (function(){ // maybe better have a state object
          var t = storage.getItem('tempo'); 
          var g = storage.getItem('gain'); 
          var bpb = storage.getItem('beatsPerBar');
          var bu = storage.getItem('beatUnit');
        
          tempo = t ? Number(t) : 123; 
          gain = g ? Number(g) : 1 / 7; 
          beatsPerBar = bpb ? Number(bpb) : 3;
          beatUnit = bu ? Number(bu) : 1 / 4;
        })()
      }

      // could as well create the widgets right here, instead of this:
      var playCtl = document.getElementById('playCtl');
      var tempoCtl = document.getElementById('tempoCtl');
      var showTempo = document.getElementById('showTempo');
      var beatsPerBarCtl = document.getElementById('beatsPerBarCtl');
      var beatUnitCtl = document.getElementById('beatUnitCtl');
      var gainCtl = document.getElementById('gainCtl');
      var showGain = document.getElementById('showGain');  
      
      var canvas = document.getElementById('beatCanvas');
      
      var debugContainer = document.getElementById('debugContainer');
      var debugField = document.getElementById('debugField');
       
      
      var trigCtl = document.getElementById('trigCtl');
      var trigCtl1 = document.getElementById('trigCtl1');
      
      var tempoSpec = { min: 20, max: 400, step: 1 };
      var gainSpec = {  min: 0, max: 1, step: "any" };
//       var resoOptions = [ '16th notes', '8th notes', 'Quarter notes' ];
            
      // setAttribute any better ?
      tempoCtl.min = tempoSpec.min;
      tempoCtl.max = tempoSpec.max;
      tempoCtl.step = tempoSpec.step;
      tempoCtl.value = tempo;
      gainCtl.min = gainSpec.min;
      gainCtl.max = gainSpec.max;
      gainCtl.step = gainSpec.step;
      gainCtl.value = gain;
      
      var beatsPerBarObj = {
        labels: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23 ], 
        values: [ 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23 ], 
        len: 23
      };
      for(var i = 0; i < beatsPerBarObj.len; i++){
        var o = document.createElement('option');
        o.textContent = beatsPerBarObj.labels[i];
        beatsPerBarCtl.add(o);
      };
      
      var beatUnitObj = {
        labels: [ '1', '1 / 2', '1 / 4', '1 / 8', '1 / 16', '1 / 32'  ], 
        values: [ 1, 1 / 2, 1 / 4, 1 / 8, 1 / 16, 1 / 32 ], 
        len: 6
      };
      for(var i = 0; i < beatUnitObj.len; i++){
        var o = document.createElement('option');
        o.textContent = beatUnitObj.labels[i];
        beatUnitCtl.add(o);
      };

      
      
      
      tempoCtl.style.width = tempoSpec.max - tempoSpec.min + 1 + 'px';
      tempoCtl.style.maxWidth = '100%'; // ha !
      
      
      gainCtl.style.width = '200px';
      
      
      function updShowTempo(){
        showTempo.textContent = tempo;
      }
      function updShowGain(){
        showGain.textContent = Math.round(gain * 100) / 100;
      }
      
      // indexOf tests for strict equality
      function updBeatsPerBarGUI(){
        beatsPerBarCtl.selectedIndex = beatsPerBarObj.values.indexOf(beatsPerBar);
      }
      function updBeatUnitGUI(){
        beatUnitCtl.selectedIndex = beatUnitObj.values.indexOf(beatUnit);
      }
      
      
      function togglePlay(ev){
//         console.log(ev);
        var str = play();
        playCtl.textContent = str;
      }

      function setTempo(bpm){
        tempo = bpm;
        updShowTempo();
      }
      
      
      function setBeatsPerBar(n) { // test, constrain ?
//         beatsPerBar = n;
        nextBeatsPerBar = n;
      }
      function setBeatUnit(x) {
//         beatUnit = x;
        nextBeatUnit = x;
      }            

      function setGain(val){
        setMainGain(val); // defined in metronome.js
        updShowGain();
      }
      
      
      // here now, called in metronome.js but layout related
      
      function resetCanvas (e) {
          // resize the canvas - but remember - this clears the canvas too.
          canvas.width = window.innerWidth;
          // canvas.height = window.innerHeight;
          canvas.height = 30;
          //make sure we scroll to the top left.
          window.scrollTo(0,0); // goog onorientationchange
      }
      
      playCtl.addEventListener('click', togglePlay, false); // touch ? click ev received iOS
//    playCtl.addEventListener('touchstart', togglePlay, false);
      
      // NB: sets nextBeatsPerBar !
      beatsPerBarCtl.addEventListener('change', function(ev){
        var ix = this.selectedIndex;
        setBeatsPerBar(beatsPerBarObj.values[ix]);
      }, false);
      
      // NB: sets nextBeatUnit !
      beatUnitCtl.addEventListener('change', function(ev){
        var ix = this.selectedIndex;
        setBeatUnit(beatUnitObj.values[ix]);
      }, false);
      
      tempoCtl.addEventListener('input', function (ev){
        setTempo(this.value);
      }, false);

      gainCtl.addEventListener('input', function (ev){
        setGain(this.value);
      }, false);
      
      
      trigCtl.addEventListener('click', function (ev){
        scheduleNote(0, audioContext.currentTime); // beatNumber, time
      }, false);
      trigCtl1.addEventListener('click', function (ev){
        scheduleNote(1, audioContext.currentTime); // beatNumber, time
      }, false);
      
      // called in init func (on win load) of metronome.js if no audio context etc
      function disablePlayCtls(){
          playCtl.disabled = true;
          trigCtl.disabled = true;
          trigCtl1.disabled = true;
      }
      
      // storage per origin 
      // arghh, spent much time only to find out 'unload' is supported by Safari mobile unlike 'beforeunload'
      if (storage){
          // window.addEventListener("beforeunload", function(ev) {    
            window.addEventListener("unload", function(ev) { 
//             console.log("beforeunload");
            
            localStorage.setItem('tempo', tempo);
            localStorage.setItem('gain', gain);            
            localStorage.setItem('beatsPerBar', beatsPerBar);
            localStorage.setItem('beatUnit', beatUnit);
          }, false);
      };
      
      nextBeatsPerBar = beatsPerBar, nextBeatUnit = beatUnit; // change only at next bar line 
      
      // init gui
      updBeatsPerBarGUI();
      updBeatUnitGUI();
      updShowTempo();
      updShowGain();

    </script>
   </body>
</html>