<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width user-scalable=no">
    <title>Metronome swit-ch testing</title>
    <!-- <link rel="stylesheet" href="css/main.css"> -->

    <style type="text/css">
/* 
      #github {
        position: absolute; top: -5px; right: 15px;
      }
 */
/* 
      input[type="range"] {
         height: 20px; width: 200px;
      }
 */
      span > #github {
        display: none;
      }
/* 
      button, select {
        font-size: 40px;
      }
 */

    </style>
    <!-- <script src="http://cwilso.github.io/AudioContext-MonkeyPatch/AudioContextMonkeyPatch.js"></script> -->
    <!-- <script src="../AudioContext-MonkeyPatch/AudioContextMonkeyPatch.js"></script> -->
    <script src="js/AudioContextMonkeyPatch.js"></script> 
        
    <script src="js/metronome.js"></script>
  </head>
  <body>
    <span>
    <a id="github" href="https://github.com/cwilso/metronome" >Fork me on GitHub</a>
    </span>
    <div id="controls">
  <!--   play doesn't  work on iOS Safari ?!   -->
      <!-- <div class="play" id="playCtl">play</div> -->
      <!-- <div><input type="button" id="playCtl" value="play"></div> -->
      <div><button type="button" id="playCtl" autofocus="true" class="play" tabindex="0"> HÃ¤? </button></div>
      
      
      <div id="tempoBox">Tempo: <span id="showTempo"></span> BPM <input id="tempoCtl" type="range"></div>      
      <div>Resolution: <select id="resoCtl"></select></div>
      <div>Gain: <span id="showGain"></span><input type="range" id="gainCtl">
      </div>
    </div>
    <script type="text/javascript"> 
      'use strict';
            
      // initial tempo, noteResolution, gain defined in metronome.js -- test override here
      // hm if localStorage undefined ==> TypeError
      tempo = localStorage.tempo ? localStorage.tempo : 123;
      gain = localStorage.gain ? localStorage.gain : 1 / 7;
      noteResolution = localStorage.noteResolution ? localStorage.noteResolution : 2;
      
      
      // don't use html ele ID as var directly, see: 
      // https://www.tjvantoll.com/2012/07/19/dom-element-references-as-global-variables/
      // could as well create the widgets here, instead of this:
      var playCtl = document.getElementById('playCtl');
      var tempoCtl = document.getElementById('tempoCtl');
      var showTempo = document.getElementById('showTempo');
      var resoCtl = document.getElementById('resoCtl');
      var gainCtl = document.getElementById('gainCtl');
      var showGain = document.getElementById('showGain');    
      
      var tempoSpec = { min: 30, max: 160, step: 1 };
      var gainSpec = {  min: 0, max: 1, step: "any" };
      var resoOptions = [ '16th notes', '8th notes', 'Quarter notes' ];
            
      // setAttribute any better ?
      tempoCtl.min = tempoSpec.min;
      tempoCtl.max = tempoSpec.max;
      tempoCtl.step = tempoSpec.step;
      tempoCtl.value = tempo;
      gainCtl.min = gainSpec.min;
      gainCtl.max = gainSpec.max;
      gainCtl.step = gainSpec.step;
      gainCtl.value = gain;
      
      var rol = resoOptions.length;
      for(var i = 0; i < rol; i++){
        var o = document.createElement('option');
        o.textContent = resoOptions[i];
        resoCtl.appendChild(o);
      }
      
      function togglePlay(ev){
        
        console.log(ev);
        
        var str = play();
        playCtl.textContent = str;
      }
      function updTempoGUI(){
        showTempo.textContent = tempo;
      }
      function setTempo(bpm){
        tempo = bpm;
        updTempoGUI();
      }
      function updGainGUI(){
        showGain.textContent = Math.round(gain * 100) / 100;
      }
      function setGain(val){
        setMainGain(val);
        updGainGUI();
      }
      
      
      playCtl.addEventListener('click', togglePlay, false); // touch ? ev received iOS but no sound/iamge
      
//       playCtl.addEventListener('touchstart', togglePlay, false);
      
      tempoCtl.addEventListener('input', function (event){
        setTempo(event.target.value);
      }, false);
      resoCtl.addEventListener('change', function (event){
        noteResolution = event.target.selectedIndex;
     }, false);
      gainCtl.addEventListener('input', function (event){
        var val = event.target.value;
        setGain(val);
      }, false);
            
      
      // storage per origin 
      window.addEventListener("beforeunload", function(ev) {    
        localStorage.setItem('tempo', tempo);
        localStorage.setItem('gain', gain);
        localStorage.setItem('noteResolution', noteResolution);
      }, false);

      
      // init gui
      updTempoGUI();
      updGainGUI();
      resoCtl.selectedIndex = noteResolution;

    </script>
   </body>
</html>