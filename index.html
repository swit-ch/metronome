<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width user-scalable=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Metronome swit-ch testing</title>
    <!-- <link rel="stylesheet" href="css/main.css"> -->
    
    <style type="text/css">
      body {
        font-family: sans-serif;
        line-height: 1.8;
        margin: 12px;
      }
      
      div#controls > div {
        padding: 0.3em 0;
      }
/* 
      div.hasSlider {
        border-top: 0.5px solid gray;
      }
      div#lastSlider {
        border-bottom: 0.5px solid gray;
      }
 */
      
        /* https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/Forms/Styling_HTML_forms */
      button, input, select, textarea {
        font-family : inherit;
        font-size   : 100%;
        /* height: 2em; */ /* slightly better iOS */
      }
      
      input[type="range"] {
        -webkit-appearance: none; /* ha */
        vertical-align: middle;
        /* border: 0.5px solid grey; */ /* not nice if appearance unchanged */
        /* border-radius: 6px; */
      }
      /* fit into whole range */
      input[type="range"]::-webkit-slider-runnable-track {
        -webkit-appearance: none;
        height: 2em;
        border: 0.5px solid grey; 
        /* border-radius: 6px; */
      }
      /* big thumb better for iOS */
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; 
        height: 2em;
        width: 2em;
        /* vertical-align: middle; */ /* no effect */
        border: 1px solid black;
        /* border-radius: 4px; */
      }
      #showTempoCtl, #showGainCtl { 
        display: inline-block;
      }
      select, button, input[type="number"] {
        width: 5em;
        text-align: center; /* not for select ? */
      }
      .activeCtl {
        /* background-color: rgba(200, 200, 255, 0.25); */ /* not visible in slider */
      }
      span.ctlLabel {
        display: inline-block;
        width: 7em;
        text-align: right;
        padding-right: 1ex;
      }
      .info { display: none; }
      
      
      canvas#barView {
        width: 100%;
        height: 30px;
      }

      div#pendulumViewContainer {
        border: 0.5px solid gray;
        height: 30px;
        width: 100%;
        position: relative; /* (not offset) for its positioned children ! */
      }
      
      /* swing and hits */
      div.pendulum {
        width: 10px;
        height: 30px;
        background-color: gray;
        position: absolute;
        left: 0;
      }
            
      div#pendulumSwing {
        -webkit-transition: left /* linear */; /* ah, curves smoother ... */
        transition: left /* linear */;
      }
      div#pendulumSwing.other {        
        left: calc(100% - 10px);
      }
      
       /* hack ? better use animation ? */
      div#pendulumHit {
        opacity: 1;
        -webkit-transition-property: none; 
        transition-property: none;
        background-color: transparent;
      }     
      div#pendulumHit.otherHit {
        opacity: 0; 
        -webkit-transition: opacity; 
        transition: opacity;
        background-color: red;
      }
      
      div#pendulumHit2 {
        left: calc(100% - 10px);
        opacity: 0; 
        -webkit-transition: opacity; 
        transition: opacity;
        background-color: red;
      }     
      div#pendulumHit2.otherHit2 {        
        opacity: 1;
        -webkit-transition-property: none; 
        transition-property: none;
        background-color: transparent; 
      }

      
      
      
      
      
      
      #debugContainer button {
        display: none;
      }
      div#postView {
          font-family: monospace;
      }
    </style>
    <script src="js/AudioContextMonkeyPatch.js"></script> 
    <script src="js/metronome.js"></script>
  </head>
  <body>
    <div id="controls">
      <!-- class 'play' rules in main.css, not used currently -->
      <div><button type="button" id="playCtl" autofocus="true" class="play activeCtl" tabindex="0"> HÃ¤? </button></div>
      
      <!-- is this a table ? A form? -->
      <div><span class="ctlLabel">Beats per bar: </span><select id="beatsPerBarCtl" class="activeCtl"></select></div>
      <div><span class="ctlLabel">Beat unit: </span><select id="beatUnitCtl" class="activeCtl"></select></div>
      
      <div class="hasSlider"><span class="ctlLabel">Tempo (1 / 4): </span>
      <!-- <span id="showTempo"></span> -->
      <input type="number" id="showTempoCtl"> 
      <span class="info">BPM</span><input id="tempoCtl" type="range" class="activeCtl"></div>      
      
      <div class="hasSlider" id="lastSlider"><span class="ctlLabel">Gain: </span>
      <!-- <span id="showGain"></span> -->
      <input type="number" id="showGainCtl">
      <input type="range" id="gainCtl" class="activeCtl"></div>
      
    </div>
    <div><canvas id="barView"></canvas></div>
    
    <div id="pendulumViewContainer">
      <div id="pendulumSwing" class="pendulum"></div>
      <div id="pendulumHit" class="pendulum"></div>
      <div id="pendulumHit2" class="pendulum"></div>
    </div>
    
    <div id="debugContainer">
      <button type="button" id="trigCtl" class="activeCtl" tabindex="0">Trig 0</button>
      <button type="button" id="trigCtl1" class="activeCtl" tabindex="0">Trig 1</button>
      <div id="postView"></div>
    </div>
    
    <script type="text/javascript"> 
      'use strict';
            
      // initial tempo, gain defined in metronome.js -- test override here
      // no localStorage in Opera mini (but audio a.o. doesn't work there anyway ...)
      // 
      var storage = window.localStorage; // possibly undefined // storage per origin
      
      // is it safe to get/set via prop name instead of getItem, setItem ?
      function readItems(store){ // oh, localStorage values always strings ?!
        var bpb = store.getItem('beatsPerBar');
        var bu = store.getItem('beatUnit');
        var t = store.getItem('tempo'); 
        var g = store.getItem('gain');
        
        var nbpb = store.getItem('nextBeatsPerBar');
        var nbu = store .getItem('nextBeatUnit');
        
        beatsPerBar = bpb ? Number(bpb) : 3;
        beatUnit = bu ? Number(bu) : 1 / 4;
        tempo = t ? Number(t) : 123; 
        gain = g ? Number(g) : 1 / 7; 
        
        nextBeatsPerBar = nbpb ? Number(nbpb) : 3;
        nextBeatUnit = nbu ? Number(nbu) : 1 / 4;
      }
      function writeItems(store){
        store.setItem('beatsPerBar', beatsPerBar);
        store.setItem('beatUnit', beatUnit);
        store.setItem('tempo', tempo);
        store.setItem('gain', gain);    
                
        store.setItem('nextBeatsPerBar', nextBeatsPerBar);
        store.setItem('nextBeatUnit', nextBeatUnit);
      }
       
      if (storage) { readItems(storage); }; // init
      
      // arghh, spent much time only to find out 'unload' is supported by Safari mobile unlike 'beforeunload'
      if (storage){
        window.addEventListener("unload", function(ev) {
          writeItems(storage);
        }, false);
      };
      
      
      // could as well create the widgets right here, instead of this:
      var playCtl = document.getElementById('playCtl');
            
      var beatsPerBarCtl = document.getElementById('beatsPerBarCtl');
      var beatUnitCtl = document.getElementById('beatUnitCtl');
      
      var tempoCtl = document.getElementById('tempoCtl');
      var showTempoCtl = document.getElementById('showTempoCtl');
      var gainCtl = document.getElementById('gainCtl');
      var showGainCtl = document.getElementById('showGainCtl');
      
      var barView = document.getElementById('barView');
      var pendulumSwing = document.getElementById('pendulumSwing');
      var pendulumHit = document.getElementById('pendulumHit');

      var debugContainer = document.getElementById('debugContainer');
      var postView = document.getElementById('postView');
       
      var trigCtl = document.getElementById('trigCtl');
      var trigCtl1 = document.getElementById('trigCtl1');
            
      var tempoSpec = { min: 10, max: 400, step: 1 };
      var gainSpec = {  min: 0, max: 1, step: "any" };
            
      // setAttribute any better ?
      tempoCtl.min = tempoSpec.min;
      tempoCtl.max = tempoSpec.max;
      tempoCtl.step = tempoSpec.step;
      tempoCtl.value = tempo;
      
      showTempoCtl.min = tempoSpec.min;
      showTempoCtl.max = tempoSpec.max;
      showTempoCtl.step = tempoSpec.step;
      showTempoCtl.value = tempo;
      showTempoCtl.pattern = "[0-9]*";
      showTempoCtl.inputmode= "numeric";
      
      gainCtl.min = gainSpec.min;
      gainCtl.max = gainSpec.max;
      gainCtl.step = gainSpec.step;
      gainCtl.value = gain;
      
      showGainCtl.min = gainSpec.min;
      showGainCtl.max = gainSpec.max;
//       showGainCtl.step = gainSpec.step;
      showGainCtl.step = 0.01;
      showGainCtl.value = gain;
      
            
      
      var beatsPerBarObj = {
        values: [
          1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23 
        ]
      };
      beatsPerBarObj.labels = beatsPerBarObj.values;
      beatsPerBarObj.len = beatsPerBarObj.values.length;
      for(var i = 0; i < beatsPerBarObj.len; i++){
        var o = document.createElement('option');
        o.textContent = beatsPerBarObj.labels[i];
        beatsPerBarCtl.add(o);
      };
      
      var beatUnitObj = {
        labels: [ '1', '1 / 2', '1 / 4', '1 / 8', '1 / 16', '1 / 32'  ] 
      };
      beatUnitObj.values = beatUnitObj.labels.map(function(item, i){
        return eval(item);
      });
      beatUnitObj.len = beatUnitObj.labels.length;
      for(var i = 0; i < beatUnitObj.len; i++){
        var o = document.createElement('option');
        o.textContent = beatUnitObj.labels[i];
        beatUnitCtl.add(o);
      };

      tempoCtl.style.width = tempoSpec.max - tempoSpec.min + 1 + 'px';
      tempoCtl.style.maxWidth = '100%'; // ha !
      gainCtl.style.width = tempoCtl.style.width;
      
      function updShowTempo(){
//         showTempo.textContent = tempo;
        showTempoCtl.value = tempo;
      }
      function updShowGain(){
//         showGain.textContent = Math.round(gain * 100) / 100;
        showGainCtl.value = Math.round(gain * 100) / 100;
      }
      
      // indexOf tests for strict equality
      function updBeatsPerBarGUI(){
        // special case: next is set, next bar not reached (?)
        var val = nextBeatsPerBar || beatsPerBar;
        beatsPerBarCtl.selectedIndex = beatsPerBarObj.values.indexOf(val);
      }
      function updBeatUnitGUI(){
      var val = nextBeatUnit || beatUnit;
        beatUnitCtl.selectedIndex = beatUnitObj.values.indexOf(val);
      }
      
      
      function togglePlay(ev){
//         console.log(ev);
        var str = play();
        playCtl.textContent = str;
      }

      function setTempo(bpm){
        tempo = bpm;
        updShowTempo();
      }
      function setGain(val){
        setMainGain(val); // defined in metronome.js
        updShowGain();
      }
      
      
      function setBeatsPerBar(n) { // test, constrain ?
//         beatsPerBar = n;
        nextBeatsPerBar = n;
      }
      function setBeatUnit(x) {
//         beatUnit = x;
        nextBeatUnit = x;
      }
      
      
      // here now, called in metronome.js but layout related
      
      function resetbarView (e) {
          // resize the canvas - but remember - this clears the canvas too.
          barView.width = window.innerWidth;
          barView.height = 30;
          //make sure we scroll to the top left.
          window.scrollTo(0,0); // goog onorientationchange
      }
      
      playCtl.addEventListener('click', togglePlay, false); // touch ? click ev received iOS
//    playCtl.addEventListener('touchstart', togglePlay, false);
      
      // NB: sets nextBeatsPerBar !
      beatsPerBarCtl.addEventListener('change', function(ev){
        var ix = this.selectedIndex;
        setBeatsPerBar(beatsPerBarObj.values[ix]);
      }, false);
      
      // NB: sets nextBeatUnit !
      beatUnitCtl.addEventListener('change', function(ev){
        var ix = this.selectedIndex;
        setBeatUnit(beatUnitObj.values[ix]);
      }, false);
      
      tempoCtl.addEventListener('input', function (ev){
        setTempo(this.value);
      }, false);

      gainCtl.addEventListener('input', function (ev){
        setGain(this.value);
      }, false);
      
      
      trigCtl.addEventListener('click', function (ev){
        scheduleNote(0, audioContext.currentTime); // beatNumber, time
      }, false);
      trigCtl1.addEventListener('click', function (ev){
        scheduleNote(1, audioContext.currentTime); // beatNumber, time
      }, false);
      
      // called in init func (on win load) of metronome.js if no audio context etc
      function disablePlayCtls(){
          playCtl.disabled = true;
          trigCtl.disabled = true;
          trigCtl1.disabled = true;
      }
            
      // init gui
      updBeatsPerBarGUI();
      updBeatUnitGUI();
      updShowTempo();
      updShowGain();

    </script>
   </body>
</html>